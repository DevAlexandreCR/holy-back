generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  EDITOR
  LEAD
  ADMIN
}

model User {
  id                  String                @id @default(uuid()) @db.Char(36)
  name                String
  email               String                @unique
  passwordHash        String                @map("password_hash")
  role                UserRole              @default(USER)
  createdAt           DateTime              @default(now()) @map("created_at")
  updatedAt           DateTime              @updatedAt @map("updated_at")
  resetToken          String?               @map("reset_token")
  resetTokenExpiresAt DateTime?             @map("reset_token_expires_at")
  deletedAt           DateTime?             @map("deleted_at")
  deletedReason       String?               @map("deleted_reason")
  settings            UserSettings?
  verseHistory        UserVerseHistory[]
  themePreferences    UserThemePreference[]
  savedVerses         UserSavedVerse[]

  @@map("users")
}

model BibleVersion {
  id           Int                @id @default(autoincrement())
  apiCode      String             @unique @map("api_code")
  name         String
  language     String
  isActive     Boolean            @default(true) @map("is_active")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")
  settings     UserSettings[]
  cachedTexts  CachedVerseText[]
  userHistory  UserVerseHistory[]
  savedVerses  UserSavedVerse[]

  @@map("bible_versions")
}

model UserSettings {
  id                 Int           @id @default(autoincrement())
  userId             String        @map("user_id")
  preferredVersionId Int?          @map("preferred_version_id")
  timezone           String?
  widgetFontSize     String?       @default("large") @map("widget_font_size")
  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")
  user               User          @relation(fields: [userId], references: [id])
  preferredVersion   BibleVersion? @relation(fields: [preferredVersionId], references: [id])

  @@unique([userId])
  @@map("user_settings")
}

model LibraryVerse {
  id           Int                @id @default(autoincrement())
  book         String
  chapter      Int
  verseFrom    Int                @map("verse_from")
  verseTo      Int                @map("verse_to")
  theme        String
  referenceKey String             @unique @map("reference_key")
  createdAt    DateTime           @default(now()) @map("created_at")

  cachedVerses CachedVerseText[]
  userHistory  UserVerseHistory[]
  savedVerses  UserSavedVerse[]

  @@unique([book, chapter, verseFrom, verseTo])
  @@index([book])
  @@map("library_verses")
}

model CachedVerseText {
  id             Int           @id @default(autoincrement())
  libraryVerseId Int           @map("library_verse_id")
  versionId      Int           @map("version_id")
  text           String        @db.Text
  reference      String
  apiMetadata    Json?         @map("api_metadata")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  libraryVerse   LibraryVerse  @relation(fields: [libraryVerseId], references: [id])
  version        BibleVersion  @relation(fields: [versionId], references: [id])

  @@unique([libraryVerseId, versionId])
  @@index([versionId])
  @@index([createdAt])
  @@map("cached_verse_texts")
}

model UserVerseHistory {
  id             Int           @id @default(autoincrement())
  userId         String        @map("user_id")
  libraryVerseId Int           @map("library_verse_id")
  versionId      Int           @map("version_id")
  date           String
  shownAt        DateTime      @default(now()) @map("shown_at")
  liked          Boolean       @default(false)
  likedAt        DateTime?     @map("liked_at")
  shared         Boolean       @default(false)
  sharedAt       DateTime?     @map("shared_at")

  user           User          @relation(fields: [userId], references: [id])
  libraryVerse   LibraryVerse  @relation(fields: [libraryVerseId], references: [id])
  version        BibleVersion  @relation(fields: [versionId], references: [id])

  @@unique([userId, libraryVerseId])
  @@unique([userId, date])
  @@index([userId])
  @@index([shownAt])
  @@index([userId, liked])
  @@index([userId, shared])
  @@map("user_verse_history")
}

model UserThemePreference {
  id              Int      @id @default(autoincrement())
  userId          String   @map("user_id")
  theme           String
  likeCount       Int      @default(0) @map("like_count")
  shareCount      Int      @default(0) @map("share_count")
  score           Float    @default(0)
  lastInteraction DateTime @default(now()) @map("last_interaction")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  user            User     @relation(fields: [userId], references: [id])

  @@unique([userId, theme])
  @@index([userId, score])
  @@map("user_theme_preferences")
}

model UserSavedVerse {
  id             Int          @id @default(autoincrement())
  userId         String       @map("user_id")
  libraryVerseId Int          @map("library_verse_id")
  versionId      Int          @map("version_id")
  reference      String
  text           String       @db.Text
  theme          String
  source         String       @default("daily_verse")
  savedAt        DateTime     @default(now()) @map("saved_at")

  user           User         @relation(fields: [userId], references: [id])
  libraryVerse   LibraryVerse @relation(fields: [libraryVerseId], references: [id])
  version        BibleVersion @relation(fields: [versionId], references: [id])

  @@unique([userId, libraryVerseId])
  @@index([userId, savedAt])
  @@map("user_saved_verses")
}
